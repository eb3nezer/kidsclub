<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>Bulk Invite</title>
    <meta name="description" content=""/>
    <meta name="viewport" content="width=device-width"/>
    <link rel="stylesheet" type="text/css" href="/webjars/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="/webjars/toastr/build/toastr.min.css"/>
    <link rel="stylesheet" type="text/css" href="/secure/css/kidsclub.css"/>
    <script type="text/javascript" src="/webjars/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="/webjars/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/webjars/toastr/build/toastr.min.js"></script>
    <script type="text/javascript" src="/secure/js/load_project.js"></script>
    <script type="text/javascript" src="/secure/js/load_user.js"></script>
    <script type="text/javascript" src="/secure/js/text_utils.js"></script>

    <script>
        var projectData;

        function renderProject(data) {
            projectData = data;
            window.title = `Bulk Invite Users to ${projectData.name}`;
            $("#team_admin_link").attr('href', `team_admin.html#project=${projectData.id}`);
            $("#invite_subheading").text(`Bulk invite new team members to ${projectData.name}`);
        }

        function getProjectFailed() {
            toastr.error('Failed to get project data', 'Failed');
        }

        function getData() {
            var results = new RegExp('#project=([^&#]*)').exec(window.location.href);
	        var project = results[1] || 0;
	        if (!project) {
	            window.location.href="./index.html";
	        }

   	        loadProject(project, renderProject, getProjectFailed);
        }

        function sendData() {
            $.ajax({
                url: "/rest/invite/bulk",
                method: "PUT",
                contentType: "application/json",
                data: JSON.stringify({
                    projectId: projectData.id,
                    emails: $("#emails_field").val(),
                }),
            }).done(function(data) {
                toastr.success('Users have been invited.', 'Success');
                var html = "<h3>Success - The following people were added</h3>";
                html += generateUserTable(data);
                $("#invited_users").html(html);
            }).fail(function(xhr, textStatus, error) {
                if (xhr && xhr.responseJSON) {
                    var errorObject = xhr.responseJSON;
                    var message = `Failed to invite users. ${errorObject.error}`;
                    toastr.error(message, 'Failed');
                 } else {
                    toastr.error('Failed to invite user.', 'Failed');
                 }
            });
        }

        function submitForm() {
            sendData();
        }

    </script>
</head>
<body class="admin">
<h1>Bulk Invite</h1>
<h2 id="invite_subheading">Invite new team members to have access</h2>
<form onsubmit="submitForm(); return false;">
<table>
        <tr><td>E-Mail Addresses (one per line)</td><td><textarea name="emails" id="emails_field" rows="8" cols="60"></textarea></td></tr>
        <tr><td><button type="submit" class="btn btn-primary" onclick="submitForm(); return false;">Invite All</button></td></tr>
</table>
</form>

<ul>
    <li><a href="team_admin.html" id="team_admin_link">Back to Administer project team</a></li>
    <li><a href="/logout">Log out</a></li>
</ul>
<div id="invited_users"></div>
<script>
    getData();
</script>
</body>
</html>