<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>Edit project details</title>
    <meta name="description" content=""/>
    <meta name="viewport" content="width=device-width"/>
    <link rel="stylesheet" type="text/css" href="/webjars/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="/webjars/toastr/build/toastr.min.css"/>
    <link rel="stylesheet" type="text/css" href="/secure/css/kidsclub.css"/>
    <script type="text/javascript" src="/webjars/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="/webjars/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/webjars/toastr/build/toastr.min.js"></script>
    <script type="text/javascript" src="/secure/js/load_project.js"></script>
    <script type="text/javascript" src="/secure/js/text_utils.js"></script>
    <script>
        var projectId;

        function renderProject(project) {
            $("#project_home_link").attr('href', `project_admin.html#project=${project.id}`);
            $("#project_home_link").text(`${project.name} Administration`);

            $("#page_heading").text(`Edit details for ${project.name}`);
            $("#name_field").val(project.name);
            if (project.properties && project.properties.studentMediaPermittedDefault && project.properties.studentMediaPermittedDefault === 'true') {
                $("#media_permitted_field").prop('checked', true);
            } else {
                $("#media_permitted_field").prop('checked', false);
            }
        }

        function loadFailed() {
            toastr.error('Failed to get project data', 'Failed');
        }

        function getData() {
            var results = new RegExp('[#&]project=([^&#]*)').exec(window.location.href);
            var project = results[1] || 0;
            if (!project) {
                window.location.href="index.html";
            }
            projectId = project;

            loadProject(projectId, renderProject, loadFailed);
        }

        function sendData() {
            var properties = {
                studentMediaPermittedDefault: $("#media_permitted_field").prop('checked'),
            };
            $.ajax({
                url: `/rest/projects/${projectId}`,
                method: "PUT",
                contentType: "application/json",
                data: JSON.stringify({
                    id: projectId,
                    name: $("#name_field").val(),
                    properties: properties,
                }),
            }).done(function(updated) {
                toastr.success('Project was created.', 'Success');
                renderProject(updated);
            }).fail(function(xhr, textStatus, error) {
                if (xhr && xhr.responseJSON) {
                    var errorObject = xhr.responseJSON;
                    var message = escapeHtml(`Failed to create project. ${errorObject.error}`);
                    toastr.error(message, 'Failed');
                 } else {
                    toastr.error('Failed to create project.', 'Failed');
                 }
            });
        }

        function submitForm() {
            sendData();
        }
    </script>
</head>
<body class="admin">
<h1 id="page_heading">Edit project</h1>
<form onsubmit="submitForm(); return false;">
    <table>
        <tr><td>Project name</td><td><input type="text" name="name" id="name_field"></td></tr>
        <tr><td colspan="2"><h3>Student defaults</h3></td></tr>
        <tr><td>Media permitted by default for students</td><td><input type="checkbox" name="mediaPermitted" id="media_permitted_field"/></td></tr>
        <tr><td><button type="submit" class="btn btn-primary" onclick="submitForm(); return false;">Update</button></td></tr>
    </table>
</form>
<ul>
    <li><a href="project_admin.html" id="project_home_link">Back</a></li>
</ul>
<ul>
    <li><a href="../logout">Log out</a></li>
</ul>
<script>
    getData();
</script>
</body>
</html>