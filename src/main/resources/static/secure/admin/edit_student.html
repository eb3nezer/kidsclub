<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>Edit a student</title>
    <meta name="description" content=""/>
    <meta name="viewport" content="width=device-width"/>
    <link rel="stylesheet" type="text/css" href="/webjars/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="/webjars/toastr/build/toastr.min.css"/>
    <link rel="stylesheet" type="text/css" href="/secure/css/kidsclub.css"/>
    <script type="text/javascript" src="/webjars/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="/webjars/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/webjars/toastr/build/toastr.min.js"></script>
    <script type="text/javascript" src="/secure/js/load_project.js"></script>
    <script type="text/javascript" src="/secure/js/load_students.js"></script>
    <script type="text/javascript" src="/secure/js/load_teams.js"></script>
    <script type="text/javascript" src="/secure/js/text_utils.js"></script>
    <script>
        var studentId;
        var projectId;
        var teams;

        function renderTeams(data) {
            teams = data;
            loadStudent(studentId, renderStudent, studentLoadFailed);
            var options = $("#team_field");
            options.append($("<option />").val("").text("No team assigned"));
            $.each(teams, function(index, team) {
                options.append($("<option />").val(team.id).text(team.name));
            });
        }

        function loadTeamsFailed() {
            toastr.error('Failed to get teams data', 'Failed');
        }

        function renderStudent(data) {
            // These go in hidden fields
            $("#id_field").val(data.id);
            $("#media_descriptor_field").val(data.mediaDescriptor);

            $("#name_field").val(data.name);
            $("#given_name_field").val(data.givenName);
            $("#family_name_field").val(data.familyName);
            $("#email_field").val(data.email);
            $("#phone_field").val(data.phone);
            $("#age_field").val(data.age);
            $("#school_field").val(data.school);
            $("#school_year_field").val(data.schoolYear);
            if (data.studentTeam && data.studentTeam.id) {
                $("#team_field").val(data.studentTeam.id);
            }
            if (data.mediaDescriptor) {
                $("#upload_preview").html(`<img src="/rest/data/download/${data.mediaDescriptor}" width="100"/>`);
            }
        }

        function studentLoadFailed() {
            toastr.error('Failed to get student data', 'Failed');
        }

        function projectLoadFailed() {
            toastr.error('Failed to get project data', 'Failed');
        }

        function renderProject(project) {
            $("#student_admin_link").attr('href', `student_admin.html#project=${project.id}`);
            $("#project_admin_link").attr('href', `project_admin.html#project=${project.id}`);
            $("#project_admin_link").text(`${project.name} Administration`);
        }

        function getData() {
            var results = new RegExp('[#&]project=([^&#]*)').exec(window.location.href);
	        var project = results[1] || 0;
	        if (!project) {
	            window.location.href="index.html";
	        }
	        projectId = project;

            results = new RegExp('[#&]student=([^&#]*)').exec(window.location.href);
	        var student = results[1] || 0;
	        if (!student) {
	            window.location.href="index.html";
	        }
	        studentId = student;

            loadProject(projectId, renderProject, projectLoadFailed);
            loadTeams(projectId, renderTeams, loadTeamsFailed);
        }

        function updateStudentFailed(xhr, textStatus, error) {
            if (xhr && xhr.responseJSON) {
                var errorObject = xhr.responseJSON;
                var message = `Failed to update your user profile. ${errorObject.error}`;
                toastr.error(message, 'Failed');
             } else {
                toastr.error('Failed to update student.', 'Failed');
             }
        }

        function sendData() {
            var form = $('form')[0]; // You need to use standard javascript object here
            var formData = new FormData(form);
            $.ajax({
                url: "/rest/students/${studentId}",
                method: "POST",
                data: formData,
                contentType: false,
                processData: false,
            }).done(function(data) {
                renderStudent(data);
                toastr.success('Student has been updated.', 'Success');
            }).fail(updateStudentFailed);
        }

        function submitForm() {
            sendData();
        }
    </script>
</head>
<body class="admin">
<h1>Edit Student</h1>
<form enctype="multipart/form-data">
    <table>
        <tr><td>Given Name</td><td><input type="text" name="givenName" id="given_name_field"></td><td></td></tr>
        <tr><td>Family Name</td><td><input type="text" name="familyName" id="family_name_field"></td><td></td></tr>
        <tr><td>Name</td><td><input type="text" name="name" id="name_field"></td><td>This is how the student will be described on this site. <b>Required</b></td></tr>
        <tr><td>Contact Phone Number(s)</td><td><input type="text" name="phone" id="phone_field"></td><td></td></tr>
        <tr><td>Contact E-Mail Address(es)</td><td><input type="text" name="email" id="email_field"></td><td></td></tr>
        <tr><td>Age</td><td><input type="text" name="age" id="age_field"></td><td></td></tr>
        <tr><td>School</td><td><input type="text" name="school" id="school_field"></td><td></td></tr>
        <tr><td>School Year</td><td><input type="text" name="schoolYear" id="school_year_field"></td><td></td></tr>
        <tr><td>Upload photo</td><td><input type="file" name="file" id="file_field"></td><td><div id="upload_preview"></div></td></tr>
        <tr><td>Team</td><td><select name="team" id="team_field"></select></td><td></td></tr>
        <tr><td><button type="submit" class="btn btn-primary" onclick="submitForm(); return false;">Update</button></td></tr>
    </table>
    <input type="hidden" name="id" id="id_field">
    <input type="hidden" name="mediaDescriptor" id="media_descriptor_field">
</form>
<ul>
    <li><a id="student_admin_link">Administer Students and Teams</a></li>
    <li><a id="project_admin_link">Back</a></li>
</ul>
<script>
    getData();
</script>
</body>
</html>