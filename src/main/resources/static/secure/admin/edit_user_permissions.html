<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>Edit user permissions</title>
    <meta name="description" content=""/>
    <meta name="viewport" content="width=device-width"/>
    <link rel="stylesheet" type="text/css" href="/webjars/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="/webjars/toastr/build/toastr.min.css"/>
    <link rel="stylesheet" type="text/css" href="/secure/css/kidsclub.css"/>
    <script type="text/javascript" src="/webjars/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="/webjars/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/webjars/toastr/build/toastr.min.js"></script>
    <script type="text/javascript" src="/secure/js/load_project.js"></script>
    <script type="text/javascript" src="/secure/js/load_students.js"></script>
    <script type="text/javascript" src="/secure/js/load_teams.js"></script>
    <script type="text/javascript" src="/secure/js/text_utils.js"></script>
    <script>
        var userId;
        var projectId;

        function sendUpdate(updateRecord, elementId) {
            $.ajax({
                url: `/rest/users/${updateRecord.user.id}/permissions`,
                method: "PUT",
                contentType: "application/json",
                data: JSON.stringify(updateRecord)
            }).done(function(data) {
                $(`#${elementId}`).removeAttr("disabled");
            }).fail(function(xhr, textStatus, error) {
                if (xhr && xhr.responseJSON) {
                    var errorObject = xhr.responseJSON;
                    var message = escapeHtml(`Failed to update permissions. ${errorObject.error}`);
                    toastr.error(message, 'Failed');
                 } else {
                    toastr.error('Failed to update permissions.', 'Failed');
                 }
            });
        }

        function updateUserPermissionRecord(checkbox) {
            $(`#${checkbox.id}`).attr("disabled", true);

            var updateRecord = {
                user: {
                    id: userId
                },
                project: {
                    id: projectId
                },
                userSitePermissions: [
                    {
                        key: checkbox.name,
                        granted: checkbox.checked
                    },
                ]
            };

            sendUpdate(updateRecord, checkbox.id);
        }

        function updateProjectPermissionRecord(checkbox) {
            $(`#${checkbox.id}`).attr("disabled", true);

            var updateRecord = {
                user: {
                    id: userId
                },
                project: {
                    id: projectId
                },
                userProjectPermissions: [
                    {
                        key: checkbox.name,
                        granted: checkbox.checked
                    },
                ]
            };

            sendUpdate(updateRecord, checkbox.id);
        }

        function renderUser(permissions) {
            document.title=`Edit Permissions for ${permissions.user.name}`;
            $("#page_heading").text(`Edit Permissions for ${permissions.user.name}`);

            if (permissions.user.mediaDescriptor) {
                $("#avatar").html(`<img src="/rest/data/download/${permissions.user.mediaDescriptor}" width="200"/>`);
            } else if (permissions.user.avatarUrl) {
                $("#avatar").html(`<img src="${permissions.user.avatarUrl}" width="200"/>`);
            }

            $("#project_heading").text(`Permissions for ${permissions.project.name}`);
            $("#team_admin_link").attr('href', `team_admin.html#project=${permissions.project.id}`);
            $("#project_admin_link").attr('href', `project_admin.html#project=${permissions.project.id}`);
            $("#project_admin_link").text(`${permissions.project.name} Administration`);

            var sitePermissions = "<table>";
            $.each(permissions.userSitePermissions, function(index, sitePermission) {
                sitePermissions += `<tr><td>${sitePermission.description}</td>`;
                sitePermissions += `<td><input  id="check_site_${sitePermission.key}" type="checkbox" name="${sitePermission.key}"`;
                if (sitePermission.granted === true) {
                    sitePermissions = sitePermissions + " checked";
                }
                sitePermissions += ' onchange="updateUserPermissionRecord(this)"';
                sitePermissions = sitePermissions + "></td></tr>";
            });
            sitePermissions = sitePermissions + "</table>";
            $("#site_permissions").html(sitePermissions);

            var projectPermissions = "<table>";
            $.each(permissions.userProjectPermissions, function(index, sitePermission) {
                projectPermissions = projectPermissions + `<tr><td>${sitePermission.description}</td>`;
                projectPermissions = projectPermissions + `<td><input id="check_project_${sitePermission.key}" type="checkbox" name="${sitePermission.key}"`;
                if (sitePermission.granted === true) {
                    projectPermissions = projectPermissions + " checked";
                }
                projectPermissions += ' onchange="updateProjectPermissionRecord(this)"';
                projectPermissions = projectPermissions + "></td></tr>";
            });
            projectPermissions = projectPermissions + "</table>";
            $("#project_permissions").html(projectPermissions);
        }

        function loadPermissions() {
            $.ajax({
                url: `/rest/users/${userId}/permissions?projectId=${projectId}`
            }).done(renderUser).fail(function() {
                toastr.error('Failed to get permissions data', 'Failed');
            });
        }

        function getData() {
            var results = new RegExp('[#&]project=([^&#]*)').exec(window.location.href);
	        projectId = results[1] || 0;
	        if (!projectId) {
	            window.location.href="index.html";
	        }

            results = new RegExp('[#&]user=([^&#]*)').exec(window.location.href);
	        userId = results[1] || 0;
	        if (!userId) {
	            window.location.href="index.html";
	        }

            loadPermissions();
        }
    </script>
</head>
<body class="admin">
<h1 id="page_heading">Edit Permissions</h1>
<div id="avatar"></div>
<h2 id="project_heading">Permissions</h2>
<div id="project_permissions"></div>
<h2>Global Permissions</h2>
<div id="site_permissions"><img src="/secure/icons/loading.gif"></div>
<ul>
    <li><a id="team_admin_link">Administer Project Members</a></li>
    <li><a id="project_admin_link">Back</a></li>
</ul>
<script>
    getData();
</script>
</body>
</html>