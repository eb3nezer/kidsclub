<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>Administer Students</title>
    <meta name="description" content=""/>
    <meta name="viewport" content="width=device-width"/>
    <link rel="stylesheet" type="text/css" href="/webjars/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="/webjars/toastr/build/toastr.min.css"/>
    <link rel="stylesheet" type="text/css" href="/secure/css/kidsclub.css"/>
    <script type="text/javascript" src="/webjars/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="/webjars/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/webjars/toastr/build/toastr.min.js"></script>
    <script type="text/javascript" src="/secure/js/load_project.js"></script>
    <script type="text/javascript" src="/secure/js/load_students.js"></script>
    <script type="text/javascript" src="/secure/js/text_utils.js"></script>
    <script>
        var projectId;

        function renderProject(project) {
            $("#page_heading").text(`Students for ${project.name}`);
            $("#project_home_link").attr('href', `project_admin.html#project=${projectId}`);
            $("#project_home_link").text(`${project.name} Administration`);
        }

        function projectLoadFailed() {
            toastr.error('Failed to get project data', 'Failed');
        }

        function deleteStudent(studentId) {
            var result = confirm(`Are you sure you want to delete this student from the project? This cannot be undone.`);
            if (result) {
                $.ajax({
                    url: `/rest/students/${studentId}`,
                    method: "DELETE",
                    contentType: "application/json",
                    data: JSON.stringify({
                        id: studentId,
                        projectId: projectId,
                    }),
                }).done(function(data) {
                    toastr.success('Student deleted.', 'Success');
                    $(`#student_${studentId}`).remove();
                }).fail(function() {
                    toastr.error('Failed to delete student.', 'Failed');
                });
            }
        }

        function renderStudents(studentData) {
            var html = "<ul>";
            $.each(studentData, function(index, student) {
                var name = escapeHtml(student.name);
                var alert = "";
                if (student.specialInstructions) {
                    alert = " <img src='/secure/icons/exclamation.gif' alt='Notes' height='25'>";
                }
                var teamLink = "(<i>No team assigned</i>)";
                if (student.studentTeam && student.studentTeam.name) {
                    var teamName = escapeHtml(student.studentTeam.name);
                    teamLink = `<a href="edit_student_team.html#project=${projectId}&team=${student.studentTeam.id}">(${teamName})</a>`;
                }
                html = html + `<li id="student_${student.id}"><div class="user_selector_container"><div class="user_selector_user"><a href="edit_student.html#project=${projectId}&student=${student.id}">${name}</a>${alert}</div><div class="user_selector_delete" onclick="deleteStudent(${student.id})">x</div> ${teamLink}</div></li>`;
                html = html + '</li>';
            });
            html = html + "</ul>";
            $("#student_list").html(html);
        }

        function studentLoadFailed() {
            toastr.error('Failed to get student data', 'Failed');
        }


        function getData() {
            var results = new RegExp('#project=([^&#]*)').exec(window.location.href);
	        var project = results[1] || 0;
	        if (!project) {
	            window.location.href="./index.html";
	        }
	        projectId = project;
            $("#add_link").attr('href', `add_student.html#project=${projectId}`);
            $("#bulk_import_link").attr('href', `bulk_add_students.html#project=${projectId}`);
            $("#bulk_export_link").attr('href', `/rest/students/export/csv/?projectId=${projectId}`);
            $("#create_team_link").attr('href', `create_student_team.html#project=${projectId}`);
            loadProject(projectId, renderProject, projectLoadFailed);

            loadStudents(projectId, renderStudents, studentLoadFailed);
        }
</script>
</head>
<body class="admin">
<h1 id="page_heading"></h1>
<div id="student_list"></div>
<ul>
    <li><a href="add_student.html" id="add_link">Add a single student</a></li>
    <li><a href="bulk_add_students.html" id="bulk_import_link">Bulk import students</a></li>
    <li><a href="bulk_add_students.html" id="bulk_export_link">Bulk export students (CSV)</a></li>
    <li><a href="create_student_team.html" id="create_team_link">Create a team</a></li>
    <li><a href="project_home.html" id="project_home_link">Back</a></li>
</ul>
<ul>
    <li><a href="../logout">Log out</a></li>
</ul>
<script>
    getData();
</script>
</body>
</html>