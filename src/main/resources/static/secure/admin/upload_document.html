<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>Upload a document</title>
    <meta name="description" content=""/>
    <meta name="viewport" content="width=device-width"/>
    <link rel="stylesheet" type="text/css" href="/webjars/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="/webjars/toastr/build/toastr.min.css"/>
    <link rel="stylesheet" type="text/css" href="/secure/css/kidsclub.css"/>
    <script type="text/javascript" src="/webjars/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="/webjars/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/webjars/toastr/build/toastr.min.js"></script>
    <script type="text/javascript" src="/secure/js/load_project.js"></script>
    <script type="text/javascript" src="/secure/js/text_utils.js"></script>
    <script>
        var projectId;

        function renderProject(project) {
            $("#project_home_link").attr('href', `project_admin.html#project=${project.id}`);
            $("#project_home_link").text(`${project.name} Admin`);
            $("#documents_link").attr('href', `edit_documents.html#project=${project.id}`);
        }

        function loadProjectFailed() {
            toastr.error('Failed to get project data', 'Failed');
        }

        function getData() {
            var results = new RegExp('#project=([^&#]*)').exec(window.location.href);
	        projectId = results[1] || 0;
	        if (!projectId) {
	            window.location="index.html";
	        }

            loadProject(projectId, renderProject, loadProjectFailed);
        }

        function renderNewDocument(thisDocument) {
            var html = "<table>";
            html += "<tr><th>Type</th><th>Updated</th><th>File</th><th>Description</th></tr>";
            var filename = escapeHtml(thisDocument.name);
            var description = escapeHtml(thisDocument.description);
            html += "<tr>";
            if (thisDocument.icon) {
                html += `<td><img src='/secure/icons/${thisDocument.icon}' width="64"/></td>`;
            } else {
                html += '<td></td>';
            }
            html += `<td>${thisDocument.updated}</td>`;
            html += `<td><a href="/rest/data/download/${thisDocument.mediaDescriptor}">${filename}</a></td>`;
            html += `<td>${description}</td>`;
            html += "</tr>";
            html += "</table>";
            $("#upload_result").html(html);
        }

        function sendData() {
            var form = $('form')[0]; // You need to use standard javascript object here
            var formData = new FormData(form);
            $.ajax({
                url: `/rest/documents/upload/${projectId}`,
                method: "POST",
                data: formData,
                contentType: false,
                processData: false,
            }).done(function(data) {
                toastr.success('Project was created.', 'Success');
                renderNewDocument(data);
            }).fail(function(xhr, textStatus, error) {
                if (xhr && xhr.responseJSON) {
                    var errorObject = xhr.responseJSON;
                    var message = escapeHtml(`Failed to upload file. ${errorObject.error}`);
                    toastr.error(message, 'Failed');
                 } else {
                    toastr.error('Failed to upload file.', 'Failed');
                 }
            });
        }

        function submitForm() {
            sendData();
        }
    </script>
</head>
<body class="admin">
<h1 id="page_heading">Add a new Document</h1>
<form enctype="multipart/form-data">
    <table>
        <tr>
            <td>Description</td>
            <td><input type="text" name="description" id="description_field"></td>
        </tr>
        <tr>
            <td>File to upload</td>
            <td><input type="file" name="file" id="file_field"></td>
        </tr>
        <tr>
            <td><button type="submit" class="btn btn-primary" onclick="submitForm(); return false;">Upload</button></td>
            <td>
                <input type="hidden" name="shared" id="shared_field" value="false">
            </td>
        </tr>
    </table>
</form>
<div id="upload_result"></div>
<ul>
    <li><a id="documents_link">Administer Documents</a></li>
    <li><a href="project_home.html" id="project_home_link">Back</a></li>
</ul>

<p><a href="../logout">Log out</a></p>
<script>
    getData();
</script>
</body>
</html>