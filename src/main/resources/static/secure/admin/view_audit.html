<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>View Audit</title>
    <meta name="description" content=""/>
    <meta name="viewport" content="width=device-width"/>
    <link rel="stylesheet" type="text/css" href="/webjars/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="/webjars/toastr/build/toastr.min.css"/>
    <link rel="stylesheet" type="text/css" href="/secure/css/kidsclub.css"/>
    <script type="text/javascript" src="/webjars/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="/webjars/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/webjars/toastr/build/toastr.min.js"></script>
    <script type="text/javascript" src="/secure/js/text_utils.js"></script>
    <script>
        var projectId;

        function readAuditFailed(xhr, textStatus, error) {
            if (xhr && xhr.responseJSON) {
                var errorObject = xhr.responseJSON;
                var message = `Failed to read audit data. ${errorObject.error}`;
                toastr.error(message, 'Failed');
             } else {
                toastr.error('Failed to read audit data.', 'Failed');
             }
        }

        function getData() {
            var results = new RegExp('#project=([^&#]*)').exec(window.location.href);
            var project;
            if (results) {
	            project = results[1] || 0;
	        }
	        var auditUrl = '/rest/audit/';
	        if (project) {
	           projectId = project;
	           auditUrl = auditUrl + "?projectId=" + projectId;
	           $("#project_home_link").attr('href', `project_admin.html#project=${projectId}`);
	        } else {
	           $("#project_home_link").attr('href', 'index.html');
	        }

            $.ajax({
                url: `${auditUrl}`
            }).done(function(data) {
                var html = "<table><tr><th>Event</th><th>Time</th><th>User</th></tr>";
                $.each(data, function(index, auditRecord) {
                    var change = escapeHtml(auditRecord.change);
                    var name;
                    if (auditRecord.user && auditRecord.user.name) {
                        name = escapeHtml(auditRecord.user.name);
                    } else {
                        name = "<i>System</i>";
                    }
                    html = html + `<tr><td>${change}</td><td>${auditRecord.changeTime}</td><td>${name}</td></tr>`;
                });
                html = html + "</table>";
                $("#audit_data").html(html);
            }).fail(readAuditFailed);
        }
</script>
</head>
<body class="admin">
<h1 id="page_heading">Audit Log</h1>
<div id="audit_data"></div>
<ul>
    <li><a href="index.html" id="project_home_link">Back</a></li>
</ul>
<ul>
    <li><a href="/logout">Log out</a></li>
</ul>
<script>
    getData();
</script>
</body>
</html>