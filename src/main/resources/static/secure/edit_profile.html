<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>Kids Club User Profile</title>
    <meta name="description" content=""/>
    <meta name="viewport" content="width=device-width"/>
    <base href="/"/>
    <link rel="stylesheet" type="text/css" href="/webjars/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="/webjars/toastr/build/toastr.min.css"/>
    <script type="text/javascript" src="/webjars/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="/webjars/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/webjars/toastr/build/toastr.min.js"></script>
    <script type="text/javascript" src="/secure/js/text_utils.js"></script>
    <script>
        function renderUser(data) {
            $("#id_field").val(data.id);
            $("#media_descriptor_field").val(data.mediaDescriptor);
            $("#name_field").val(data.name);
            $("#given_name_field").val(data.givenName);
            $("#family_name_field").val(data.familyName);
            $("#email_field").text(data.email);
            $("#home_phone_field").val(data.homePhone);
            $("#mobile_phone_field").val(data.mobilePhone);
            $("#avatar_field").val(data.avatarUrl);
            if (data.avatarUrl) {
                $("#avatar_preview").html(`<img src="${data.avatarUrl}" width="100"/>`);
            }
            if (data.mediaDescriptor) {
                $("#upload_preview").html(`<img src="/rest/data/download/${data.mediaDescriptor}" width="100"/>`);
            }
        }

        function getData() {
            $.ajax({
                url: "/rest/users/me"
            }).done(renderUser).fail(function() {
                toastr.error('Failed to get user data', 'Failed');
            });
        }

        function sendData() {
            // Work around for empty file upload bug
            if (is_safari) {
                var $form = $('form');
                var $inputs = $('input[type="file"]:not([disabled])', $form);
                $inputs.each(function(_, input) {
                    if (input.files.length > 0) return;
                    $(input).prop('disabled', true);
                })
            }
            var form = $('form')[0]; // You need to use standard javascript object here
            var formData = new FormData(form);
            $.ajax({
                url: "/rest/users",
                method: "POST",
                data: formData,
                contentType: false,
                processData: false,
            }).done(function(data) {
                renderUser(data);
                toastr.success('User profile has been updated.', 'Success');
            }).fail(function(xhr, textStatus, error) {
                if (xhr && xhr.responseJSON) {
                    var errorObject = xhr.responseJSON;
                    var message = `Failed to update your user profile. ${errorObject.error}`;
                    toastr.error(message, 'Failed');
                 } else {
                    toastr.error('Failed to update your user profile.', 'Failed');
                 }
            });
        }

        function submitForm() {
            sendData();
        }
    </script>
</head>
<body>
<h1>Edit User Profile</h1>
<form enctype="multipart/form-data">
    <table>
        <tr><td>Given Name</td><td><input type="text" name="givenName" id="given_name_field"></td><td></td></tr>
        <tr><td>Family Name</td><td><input type="text" name="familyName" id="family_name_field"></td><td></td></tr>
        <tr><td>Name</td><td><input type="text" name="name" id="name_field"></td><td>How you would like to be known on this site. <b>Required</b></td></tr>
        <tr><td>Mobile Number</td><td><input type="text" name="mobilePhone" id="mobile_phone_field"></td><td></td></tr>
        <tr><td>Home Number</td><td><input type="text" name="homePhone" id="home_phone_field"></td><td></td></tr>
        <tr><td>E-Mail Address</td><td id="email_field"></td><td>You need to contact an admin if you want to change your email address.</td></tr>
        <tr><td>Avatar URL</td><td><input type="text" name="avatarUrl" id="avatar_field"></td><td><div id="avatar_preview"></div></td></tr>
        <tr><td>Upload photo</td><td><input type="file" name="file" id="file_field"></td><td><div id="upload_preview"></div></td></tr>
        <tr><td><button type="submit" class="btn btn-primary" onclick="submitForm(); return false;">Update</button></td></tr>
    </table>
    <input type="hidden" name="id" id="id_field">
    <input type="hidden" name="mediaDescriptor" id="media_descriptor_field">
</form>
<script>
    getData();
</script>
</body>
</html>