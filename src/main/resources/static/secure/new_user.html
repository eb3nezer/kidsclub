<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>New User</title>
    <meta name="description" content=""/>
    <meta name="viewport" content="width=device-width"/>
    <link rel="stylesheet" type="text/css" href="/webjars/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="/webjars/toastr/build/toastr.min.css"/>
    <script type="text/javascript" src="/webjars/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="/webjars/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/webjars/toastr/build/toastr.min.js"></script>
    <script>
        var redirectDone = function() {
            window.location.href="index.html";
        };

        function getData() {
            $.ajax({
                url: "../../rest/users/me"
            }).done(function(data) {
                $("#id_field").val(data.id);
                $("#given_name_field").val(data.givenName);
                $("#family_name_field").val(data.familyName);
                $("#name_field").val(data.name);
                $("#email_field").val(data.email);
                $("#avatar_field").val(data.avatarUrl);
                if (data.avatarUrl) {
                    $("#avatar_preview").html(`<img src="${data.avatarUrl}" width="64"/>`);
                }
            }).fail(function() {
                toastr.error('Failed to get user data', 'Failed');
            });
        }

        function sendData() {
            $.ajax({
                url: "../../rest/users",
                method: "PUT",
                contentType: "application/json",
                data: JSON.stringify({
                    id: $("#id_field").val(),
                    name: $("#name_field").val(),
                    givenName: $("#given_name_field").val(),
                    familyName: $("#family_name_field").val(),
                    email: $("#email_field").val(),
                    avatarUrl: $("#avatar_field").val(),
                }),
            }).done(function(data) {
                $("#id_field").val(data.id);
                $("#name_field").val(data.name);
                $("#email_field").val(data.email);
                toastr.options.onHidden = redirectDone;
                toastr.options.onCloseClick = redirectDone;
                toastr.success('User profile has been updated.', 'Success');
            }).fail(function(xhr, textStatus, error) {
                if (xhr && xhr.responseJSON) {
                    var errorObject = xhr.responseJSON;
                    var message = `Failed to update your user profile. ${errorObject.error}`;
                    toastr.error(message, 'Failed');
                 } else {
                    toastr.error('Failed to update your user profile.', 'Failed');
                 }
            });
        }

        function submitForm() {
            sendData();
        }
    </script>
</head>
<body>
<h1>Welcome</h1>
<p>It looks like this is the first time on this site. How about you take a moment to check if your
    user profile information is correct.</p>
<form onsubmit="submitForm(); return false;">
<table>
    <tr><td>Given Name</td><td><input type="text" name="given_name" id="given_name_field"></td><td></td></tr>
    <tr><td>Family Name</td><td><input type="text" name="family_name" id="family_name_field"></td><td></td></tr>
    <tr><td>Name</td><td><input type="text" name="name" id="name_field"></td><td>How you would like to be known on this site.</td></tr>
    <tr><td>E-Mail Address</td><td><input type="text" name="email" id="email_field"></td><td>You need to contact an admin if you want to change your email address.</td></tr>
    <tr><td>Avatar URL</td><td><input type="text" name="name" id="avatar_field"></td><td><div id="avatar_preview"></div></td></tr>
    <tr><td><button type="submit" class="btn btn-primary" onclick="submitForm(); return false;">Update</button> <button type="submit" class="btn" onclick="redirectDone(); return false;">Continue</button></td></tr>
</table>
    <input type="hidden" name="id" id="id_field">
</form>
<p><div id="error_message"></div></p>
<script>
    getData();
</script>
</body>
</html>