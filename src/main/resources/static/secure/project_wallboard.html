<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>Wallboard</title>
    <meta name="description" content=""/>
    <meta name="viewport" content="width=device-width"/>
    <link rel="stylesheet" type="text/css" href="/webjars/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="/webjars/toastr/build/toastr.min.css"/>
    <link rel="stylesheet" type="text/css" href="css/kidsclub.css"/>
    <script type="text/javascript" src="/webjars/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="/webjars/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/webjars/toastr/build/toastr.min.js"></script>
    <script type="text/javascript" src="js/text_utils.js"></script>
    <script type="text/javascript" src="js/load_project.js"></script>
    <script type="text/javascript" src="js/load_teams.js"></script>
    <script>
        var projectData;
        var teamsHtml;
        var timer;

        function renderProject(project) {
            projectData = project;
            document.title = `${project.name} Scoreboard`;
            $("#page_heading").text(`${project.name} Scoreboard`);
        }

        function renderTeam(team) {
            var result = "";
            var teamName = escapeHtml(team.name);
            result += `<td><h1 align="center">${teamName}</h1>`;
            result += '<p alignn="center">';
            if (team.mediaDescriptor) {
                result += `<img src='../../rest/data/download/${team.mediaDescriptor}' width='200'/>`;
            } else if (team.avatarUrl) {
                result += `<img src='${team.avatarUrl}' width='200'/>`;
            }
            result += `</p><h1 align="center" class="score" id="score_${team.id}">${team.score}</h1></td>`;
            return result;
        }

        function renderTeams(teams) {
            teamsHtml = '<table width="100%" height="100%"><tr>';
            $.each(teams, function(index, team) {
                teamsHtml += renderTeam(team);
            });
            teamsHtml += '</tr></table>';
            $('#student_teams').html(teamsHtml);
            timer = setTimeout(refreshScores, 10000);
        }

        function loadError() {
            toastr.error('Failed to load teams', 'Failed');
        }

        function getData() {
            var results = new RegExp('#project=([^&#]*)').exec(window.location.href);
	        var project = results[1] || 0;
	        if (!project) {
	            window.location.href="index.html";
	        }
	        loadProject(project, renderProject, loadError);
            loadTeams(project, renderTeams, loadError);
        }

        function renderUpdatedScores(teams) {
            $.each(teams, function(index, team) {
                var currentScore = parseInt($(`#score_${team.id}`).text());
                if (currentScore !== team.score) {
                    $(`#score_${team.id}`).text(team.score);
                    if (team.score > currentScore) {
                        $(`#score_${team.id}`).addClass("score_up");
                        setTimeout(function () {
                            $(`#score_${team.id}`).removeClass("score_up");
                        }, 2000);
                    } else {
                        $(`#score_${team.id}`).addClass("score_down");
                        setTimeout(function () {
                            $(`#score_${team.id}`).removeClass("score_down");
                        }, 2000);
                    }
                }
            });

            timer = setTimeout(refreshScores, 10000);
        }

        function refreshScores() {
            console.log("Refreshing scores");
            loadTeams(projectData.id, renderUpdatedScores, function() {
                console.error("Failed to load teams to update scores");
            });
        }

</script>
</head>
<body>
<h1 id="page_heading"></h1>
<div id="student_teams"></div>
<script>
    getData();
</script>
</body>
</html>